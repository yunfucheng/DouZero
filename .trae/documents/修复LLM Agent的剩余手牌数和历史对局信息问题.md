## 问题分析

1. **各家剩余手牌数没有正确赋值**
   - 原因：当前代码依赖 `infoset.player_card_counts` 属性，但该属性可能不存在或未被正确设置
   - 现象：日志中显示「各家剩余手牌数: 」为空
   - 影响：LLM无法准确判断牌局阶段和风险

2. **历史对局信息可以优化**
   - 现状：简单的列表格式，包含所有出牌记录
   - 问题：信息量大，难以快速提取关键信息
   - 优化空间：更有层次、更易读的格式，添加统计信息

## 修复方案

### 1. 手动计算各家剩余手牌数
- **修改位置**：`create_comprehensive_prompt` 方法
- **实现逻辑**：
  - 计算总牌数：54张
  - 计算已出牌总数：遍历 `self.game_state['played_cards']` 求和
  - 计算自己的手牌数：`len(self.game_state['hand_cards'])`
  - 计算对手剩余牌数：总牌数 - 已出牌数 - 自己的手牌数
  - 合理分配给两家对手

### 2. 优化历史对局信息
- **修改位置**：`create_comprehensive_prompt` 方法中的历史构建部分
- **优化方向**：
  - 按轮次分组，清晰展示每一轮的出牌顺序
  - 添加关键统计信息：
    - 各方出牌次数
    - 各方使用的炸弹数量
    - 各方出牌的主要牌型（顺子、对子、三带等）
  - 突出显示最近几轮的关键出牌

### 3. 增强牌局阶段判断
- **修改位置**：提示词中的决策指导部分
- **实现逻辑**：
  - 根据已出牌数量和剩余牌数自动判断牌局阶段
  - 在提示词中明确标识当前阶段
  - 为不同阶段提供更具体的策略建议

## 预期效果

- **更准确的剩余手牌数**：LLM将获得准确的各家剩余手牌信息
- **更清晰的历史对局**：LLM可以快速理解牌局发展和对手策略
- **更好的决策依据**：结合牌局阶段判断，做出更合理的决策
- **更详细的统计信息**：帮助LLM分析对手出牌模式

## 代码修改点

1. `create_comprehensive_prompt` 方法：添加手动计算剩余手牌数的逻辑
2. `create_comprehensive_prompt` 方法：优化历史对局信息的格式化
3. 提示词模板：增强牌局阶段判断的描述

## 实施步骤

1. 修改 `create_comprehensive_prompt` 方法，添加剩余手牌数计算逻辑
2. 优化历史对局信息的构建和格式化
3. 更新提示词模板，增强牌局阶段判断
4. 测试修复后的效果，验证剩余手牌数和历史信息的准确性

该修复方案将确保LLM获得更准确、更有用的游戏状态信息，从而做出更好的决策。